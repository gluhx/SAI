{% extends "base.html" %}
{% block title %}–°–ª–æ—Ç—ã –∏ –æ–ø–µ—Ä–∞—Ü–∏–∏ ‚Äî –≠–∫—Å–ø–µ—Ä—Ç{% endblock %}
{% block page_title %}–°–ª–æ—Ç—ã –∏ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ñ—Ä–µ–π–º–∞ ¬´{{ frame_data.name if frame_data else '' }}¬ª{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='styles/expert/expert.css') }}">
{% endblock %}

{% block content %}
<main class="slot-assignment-main">
    <!-- –í—ã–±–æ—Ä –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞ -->
    <h2>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ç–æ—Ç–∏–ø</h2>
    <form method="get" action="/expert/frame-slots" class="prototype-select">
        <select name="frame" onchange="this.form.submit()">
            <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>
            {% for f in frames %}
                <option value="{{ f[0] }}" {% if selected_frame == f[0]|string %}selected{% endif %}>{{ f[1] }}</option>
            {% endfor %}
        </select>
    </form>

    {% if frame_data %}
        <!-- === –°–õ–û–¢–´ === -->
        <h3>–°–ª–æ—Ç—ã –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞ "{{ frame_data.name }}"</h3>
        <div class="slot-cards-container">
            {% for item in frame_data.assigned_slots %}
                <div class="slot-card">
                    <div class="slot-name">{{ item.slot_name }}</div>
                    <div class="value-box">{{ item.value_name }}</div>
                    <div class="actions">
                        <a href="/expert/frame-slot/{{ item.frame_value_id }}/delete?frame_id={{ selected_frame }}"
                           class="btn-delete"
                           onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ —Å–ª–æ—Ç–∞?')">
                            –£–¥–∞–ª–∏—Ç—å
                        </a>
                    </div>
                </div>
            {% else %}
                <p class="no-slots-message">–£ –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞ –ø–æ–∫–∞ –Ω–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤.</p>
            {% endfor %}
        </div>

        <h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å–ª–æ—Ç</h3>
        <div class="add-slot-form-container">
            <form method="post" action="/expert/frame/{{ selected_frame }}/slot/add">
                <select name="slot_id" required>
                    <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —Å–ª–æ—Ç ‚Äî</option>
                    {% for sid, sname in all_slots %}
                        <option value="{{ sid }}">{{ sname }}</option>
                    {% endfor %}
                </select>
                <select name="value_id" required>
                    <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî</option>
                </select>
                <button type="submit">–î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ—Ç</button>
            </form>
        </div>

        <!-- === –û–ü–ï–†–ê–¶–ò–ò === -->
        <h3 class="operations-title">–û–ø–µ—Ä–∞—Ü–∏–∏ —Ñ—Ä–µ–π–º–∞ "{{ frame_data.name }}"</h3>

        <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏ -->
        <div class="add-operation-form-container">
            <form method="get" action="/expert/frame-slots" class="group-select-form">
                <input type="hidden" name="frame" value="{{ selected_frame }}">
                <select name="group" onchange="this.form.submit()" class="group-select">
                    {% for g in groups %}
                        <option value="{{ g[0] }}" {% if selected_group == g[0] %}selected{% endif %}>
                            {{ g[1] }} ({{ "%02d"|format(g[2]) }}00)
                        </option>
                    {% endfor %}
                </select>
            </form>

            <form method="post" action="/expert/frame/{{ selected_frame }}/operation/add" class="operation-add-form">
                <input type="hidden" name="frame_id" value="{{ selected_frame }}">
                <div class="form-group">
                    <label>–û–ø–µ—Ä–∞—Ü–∏—è</label>
                    <select name="operation_id" required class="operation-select">
                        <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>
                        {% for op in group_operations %}
                            <option value="{{ op[0] }}">
                                ({{ "%02d"|format(selected_group) }}{{ "%02d"|format(op[1]) }}) {{ op[2] }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <select name="tool_id" class="tool-select">
                        <option value="">‚Äî –ù–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî</option>
                        {% for t in tools %}
                            <option value="{{ t[0] }}">{{ t[1] }}</option>
                        {% endfor %}
                    </select>
                </div>
                <input type="hidden" name="duration" value="0">
                <button type="submit" class="btn-primary">–î–æ–±–∞–≤–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é</button>
            </form>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π -->
        {% if operations %}
            <div class="operations-table">
                <div class="operations-header">
                    <div>–ö–æ–¥</div>
                    <div>–û–ø–µ—Ä–∞—Ü–∏—è</div>
                    <div>–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</div>
                    <div>–î–µ–π—Å—Ç–≤–∏—è</div>
                </div>
                {% for op in operations %}
                    <div class="operation-row">
                        <div>{{ "%02d"|format(op.group_number) }}{{ "%02d"|format(op.operation_number) }}</div>
                        <div>{{ op.name }}</div>
                        <div>{{ op.tool or '‚Äî' }}</div>
                        <div class="operation-actions">
                            <a href="/expert/frame-op/{{ op.id }}/delete" class="btn-delete" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é?')">üóëÔ∏è</a>
                            {% if not loop.first %}
                                <a href="/expert/frame-op/{{ op.id }}/up" class="btn-move">‚Üë</a>
                            {% endif %}
                            {% if not loop.last %}
                                <a href="/expert/frame-op/{{ op.id }}/down" class="btn-move">‚Üì</a>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="no-operations-message">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π.</p>
        {% endif %}
    {% endif %}
</main>

<script>
document.querySelector('select[name="slot_id"]').addEventListener('change', function() {
    const slotId = this.value;
    const valueSelect = document.querySelector('select[name="value_id"]');
    valueSelect.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî</option>';
    if (!slotId) return;
    fetch(`/expert/slot/${slotId}/values`)
        .then(r => r.json())
        .then(values => {
            values.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v.id;
                opt.textContent = v.name;
                valueSelect.appendChild(opt);
            });
        });
});
</script>
{% endblock %}
